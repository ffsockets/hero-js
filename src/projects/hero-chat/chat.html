<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <script src='/socket.io/socket.io.js'></script>
  <!-- <script src="./app/autoRefresh.js"></script> -->
  <script src="./app/config.js"></script>
  <script src="./app/shareViews.js"></script>
  <script src="./app/herohelper.js"></script>
  <script src="./app/fu.js"></script>
  <script src="./app/hero.js"></script>
  <script>

    var mypub;
    var yourpub;
    Hero.on = function(data){
      if (data.msg) {
        Hero.addMsg(data.msg);
      }

      if (data.pub) {
        mypub = data.pub;
      }

      if (data.encrypt) {
        var msg = {self:true, nickname:'Me', text:data.encrypt.result};
        // alert('encrypt origin: ' + data.encrypt.original + '    encrypted: ' + data.encrypt.result)
        window._io.emit('heroChat', {req:'post',payload:msg, encrypted:true, pub:mypub});
        Hero.datas({name:'chat',newMsg:{self:true,nickname:'Me',text:decodeURI(data.encrypt.original)},avatar:''});
        Hero.datas({
          name:'db', 
          arrayKey: Hero.getInitData().address, 
          value: {
            timestamp: Math.floor(Date.now() / 1000), 
            self: true, 
            text: decodeURI(data.encrypt.original),
            nickname: 'Me'
          }
        })
      }

      if (data.decrypt) {
        var decodedText = decodeURI(data.decrypt.result);
        var message = {self:false, nickname:data.decrypt.payload.nickname, text: decodedText};
        Hero.datas({name:'chat', newMsg:message, avatar:''});
        Hero.datas({
          name:'db', 
          arrayKey: Hero.getInitData().address, 
          value: {
            timestamp: Math.floor(Date.now() / 1000), 
            self: false, 
            text: message,
            nickname: data.decrypt.payload.nickname
          }
        })
      }

      if (data.arrayKey) {
        var value = data.value;
        for (var i=0; i<value.length; i++) {
          var payload = value[i];
          var message = {self: payload.self, nickname: payload.nickname, text:payload.text}
          Hero.datas({name:'chat', newMsg:message, avatar:''})
        }
      }
    };
    var i = 0;
    Hero.job = function(){
      var msg = msgs[i];
      Hero.out({datas:{name:'chat',newMsg:msg}});
      if (i < msgs.length) {
        i++
      }else{
        return;
      }
      setTimeout(function(){
        Hero.job();
      },2000)
    }
    Hero.addMsg = function(text){
      var encodedText = encodeURI(text);
      if (yourpub) {
        Hero.datas({name:'sig', encrypt:{data: encodedText, pub: yourpub}});
      } else {
        var msg = {self:true,nickname:'Me',text:encodedText};
        window._io.emit('heroChat', {req:'post', payload:msg, encrypted:false, pub:mypub});
        Hero.datas({name:'chat',newMsg:{self:true,nickname:'Me',text:text}, avatar:''});
        Hero.datas({
          name:'db', 
          arrayKey: Hero.getInitData().address, 
          value: {
            timestamp: Math.floor(Date.now() / 1000), 
            self: true, 
            text: text,
            nickname: 'Me'
          }
        })
      }
    };
    Hero.viewWillAppear = function() {
      if (!window._io) {
        window._io = io.connect();
      };
      window._io.on('heroChat', function(data) {
        if (data.req === 'newMessage') {
          var payloads = data.res;
          for (var i = 0; i < payloads.length; i++) {
            var payload = payloads[i];
            yourpub = payload.pub;
            if (payload.encrypted) {
              Hero.datas({name:'sig', decrypt: payload})
            } else {
              var decodedText = decodeURI(payload.payload.text)
              var message = {self:false, nickname:payload.payload.nickname, text: decodedText}
              Hero.datas({name:'chat', newMsg:message, avatar:''})
              Hero.datas({
                name:'db', 
                arrayKey: Hero.getInitData().address, 
                value: {
                  timestamp: Math.floor(Date.now() / 1000), 
                  self: false, 
                  text: message,
                  nickname: data.decrypt.payload.nickname
                }
              })
            }
          }
        }
        if (data.req === 'chatConnect' && data.res === 'success') {
          window._io.emit('heroChat', {req:'fetch'});
          window._io.emit('heroChat', {req:'subscribe'})
        }
      });
      var address = Hero.getInitData().address;

      // load local messages
      Hero.datas({
          name:'db',
          arrayKey: address, 
      })

      window._io.emit('heroChat', {req:'chatConnect','from':localStorage.chatAcount,'to':address});
      Hero.datas({name:'sig', pub:true})
    };
    Hero.viewWillDisAppear = function() {

    };
    Hero.viewDidload = function() {

    };
    Hero.ui = {
      nav:{
        title:Hero.getInitData().title,
        navigationBarHidden:false
      },
      views:
      [
        {
          class:'HeroChatView',
          frame:{w:'1x',h:'1x'},
          name:'chat'
        },
        {
          class:'HeroSignature',
          name:'sig',
          hidden:true,
        },
        {
          class:'HeroDB',
          name:'db',
          hidden:true,
        }
      ],
    };

  </script>
</head>
<body>
</body>
</html>
