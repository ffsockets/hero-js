<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <script src='/socket.io/socket.io.js'></script>
  <!-- <script src="./app/autoRefresh.js"></script> -->
  <script src="./app/config.js"></script>
  <script src="./app/shareViews.js"></script>
  <script src="./app/herohelper.js"></script>
  <script src="./app/fu.js"></script>
  <script src="./app/hero.js"></script>
  <script>
  // var msgs = [

  //   {
  //     text:'Hi, What \'s are you doing?',
  //     self:false,
  //     nickname:'Vitalik',
  //     avatar:'https://img2.woyaogexing.com/2018/11/05/e37eafb8923f4f62!400x400_big.jpg' 
  //   },
  //   {
  //     text:'Buy more eth !!',
  //     self:true,
  //     nickname:'Me',
  //     avatar:'https://img2.woyaogexing.com/2018/11/09/2ab8e98a388a5251!400x400_big.jpg' 
  //   },

  // ];

    var mypub;
    var yourpub = '0xf2e0c123f725cc00d38f46786bea9efc2e07f26af555b843015fdbf265ad7326f3cdab33bc7eb0c2948d08f1fa37921dec6fb4c5cc56ac6b502cfc05dc6003f6';
    Hero.on = function(data){
      if (data.msg) {
        Hero.addMsg(data.msg);
      }

      if (data.pub) {
        alert('pub' + data.pub)
        mypub = data.pub;
      }

      if (data.encrypt) {
        var msg = {self:true, nickname:'Me', text:data.encrypt.result};
        alert('encrypt origin: ' + data.encrypt.original + '    encrypted: ' + data.encrypt.result)
        window._io.emit('heroChat', {req:'post',payload:msg, encrypt:true, pub:mypub});
        Hero.datas({name:'chat',newMsg:{self:true,nickname:'Me',text:data.encrypt.original},avatar:''});
      }

      if (data.decrypt) {
        var message = {self:false, nickname:payload.nickname, text: payload.result}
        Hero.datas({name:'chat', newMsg:message, avatar:''})
      }
    };
    var i = 0;
    Hero.job = function(){
      var msg = msgs[i];
      Hero.out({datas:{name:'chat',newMsg:msg}});
      if (i < msgs.length) {
        i++
      }else{
        return;
      }
      setTimeout(function(){
        Hero.job();
      },2000)
    }
    Hero.addMsg = function(text){
      if (yourpub) {
        Hero.datas({name:'sig', encrypt:{data: text, pub: yourpub}})
      } else {
        var msg = {self:true,nickname:'Me',text:text};
        window._io.emit('heroChat', {req:'post', payload:msg, encrypt:false, pub:mypub});
        Hero.datas({name:'chat',newMsg:msg,avatar:''});
      }
    };
    Hero.viewWillAppear = function() {
      if (!window._io) {
        window._io = io.connect();
        window._io.on('heroChat', function(data) {
          if (data.req === 'newMessage') {
            var payloads = data.res;
            for (var i = 0; i < payloads.length; i++) {
              var payload = payloads[i];
              if (payload.encrypt) {
                Hero.datas({name:'sig', decrypt: payload})
              } else {
                var message = {self:false, nickname:payload.nickname, text: payload.text}
                Hero.datas({name:'chat', newMsg:message, avatar:''})
              }
            }
          }
          if (data.req === 'chatConnect' && data.res === 'success') {
            window._io.emit('heroChat', {req:'fetch'});
            window._io.emit('heroChat', {req:'subscribe'})
          }
        });
      };
      var address = Hero.getInitData().address;
      window._io.emit('heroChat', {req:'chatConnect','from':localStorage.chatAcount,'to':address});
      Hero.datas({name:'sig', pub:true})
      
    };
    Hero.viewWillDisAppear = function() {

    };
    Hero.viewDidload = function() {

    };
    Hero.ui = {
      nav:{
        title:Hero.getInitData().title,
        navigationBarHidden:false
      },
      views:
      [
        {
          class:'HeroChatView',
          frame:{w:'1x',h:'1x'},
          name:'chat'
        },
        {
          class:'HeroSignature',
          name:'sig',
          hidden:true,
        }
      ],
    };

  </script>
</head>
<body>
</body>
</html>
